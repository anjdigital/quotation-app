<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sublimation Quotation System – Consolidated & Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- jsPDF AutoTable (PLUGIN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{max-width:1100px;margin:auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
label{font-weight:bold}
input,textarea{width:100%;padding:6px;margin:4px 0;border:1px solid #ccc;border-radius:6px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px}
th{background:#eef2f5}
button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer}
.add{background:#2563eb;color:#fff}
.pdf{background:#dc2626;color:#fff}
.cost{background:#6b7280;color:#fff}
.result{background:#eef2f5;padding:10px;border-radius:6px;margin-top:10px}
img.preview{width:50px;height:50px;object-fit:cover}
#logoPreview{max-height:80px;display:block;margin-bottom:10px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
.modal-box{background:#fff;padding:20px;border-radius:10px;width:360px}
</style>
</head>
<body>
<div class="container">

<label>Company Logo (session only)</label>
<input type="file" id="logoInput" accept="image/*" />
<img id="logoPreview" />

<h2 style="text-align:center">A. N. J DIGITAL PRINTING</h2>
<h3 style="text-align:center">Guyong Sta. Maria, Bulacan</h3>
<h3 style="text-align:center">Nino C. Historillo</h3>
<h3 style="text-align:center">0906 474 1203</h3>


<hr />

<div style="display:flex;gap:10px">
  <div><label>Quotation No</label><input id="qno" readonly /></div>
  <div><label>Date</label><input type="date" id="qdate" /></div>
</div>

<label>Client Name</label>
<input id="customer" />

<table id="itemsTable">
<thead>
<tr>
  <th>Photo</th>
  <th>Description</th>
  <th>Qty</th>
  <th>Unit Price</th>
  <th>Total</th>
  <th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button class="add" id="addItemBtn">+ Add Item</button>
<div class="result" id="grand">Total: ₱0.00</div>

<!-- ===== REMARKS ===== -->
<label for="remarks" style="margin-top:15px;display:block;">
  Remarks / Terms & Conditions
</label>

<textarea
  id="remarks"
  rows="4"
  placeholder="Enter remarks, terms, or notes here..."
>
Price is VAT exclusive
50% downpayment required to start the job
Prices are subject to change without prior notice
</textarea>

<!-- ===== END REMARKS ===== -->

<button class="pdf" id="saveBtn">Save & Generate PDF</button>

<hr />
<h3>Quotation History</h3>
<table id="historyTable">
<thead><tr><th>No</th><th>Date</th><th>Client</th><th>Total</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>
</div>

<!-- COST MODAL -->
<div class="modal" id="costModal">
  <div class="modal-box">
    <h3>Hidden Cost (Internal)</h3>
    <input type="hidden" id="rowIndex" />
    <label>Base Cost</label><input type="number" id="baseCost" value="0" />
    <label>Markup (%)</label><input type="number" id="markup" value="30" />
    <div class="result" id="costPreview"></div>
    <button class="add" id="applyCostBtn">Apply</button>
    <button id="closeCostBtn">Close</button>
  </div>
</div>

<script>
/* ================== CORE STATE ================== */
const { jsPDF } = window.jspdf;
const peso = v => '₱'+Number(v||0).toLocaleString('en-PH',{minimumFractionDigits:2});

let quoteCounter = Number(localStorage.getItem('qcounter')) || 141;
let quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
let sessionLogo = '';

qno.value = quoteCounter;
qdate.valueAsDate = new Date();

/* ================== LOGO (SESSION ONLY) ================== */
logoInput.onchange = () => {
  const f = logoInput.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = e => { sessionLogo = e.target.result; logoPreview.src = sessionLogo; };
  r.readAsDataURL(f);
};

/* ================== ITEMS ================== */
function addRow(item = {}){
  const tr = itemsTable.tBodies[0].insertRow();
  tr.dataset.image = '';

  tr.innerHTML = `
    <td><input type="file" class="imgInp" accept="image/*"><br><img class="preview"></td>
    <td><input value="${item.desc||''}"></td>
    <td><input type="number" class="qty" value="${item.qty||1}"></td>
    <td><input type="number" class="price" value="${item.price||0}"></td>
    <td>₱0.00</td>
    <td><button class="cost">Cost</button></td>`;

  tr.querySelector('.qty').oninput = calc;
  tr.querySelector('.price').oninput = calc;
  tr.querySelector('.cost').onclick = () => openCost(tr);

  tr.querySelector('.imgInp').onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = x => { tr.dataset.image = x.target.result; tr.querySelector('img').src = x.target.result; };
    r.readAsDataURL(f);
  };

  calc();
}

function calc(){
  let sum = 0;
  [...itemsTable.tBodies[0].rows].forEach(r => {
    const q = +r.querySelector('.qty').value || 0;
    const p = +r.querySelector('.price').value || 0;
    const t = q * p;
    r.cells[4].innerText = peso(t);
    sum += t;
  });
  grand.innerText = `Total: ${peso(sum)}`;
}

/* ================== HIDDEN COST ================== */
function openCost(tr){
  rowIndex.value = [...itemsTable.tBodies[0].rows].indexOf(tr);
  baseCost.value = 0;
  markup.value = 30;
  updateCostPreview();
  costModal.style.display = 'flex';
}

function updateCostPreview(){
  const sell = +baseCost.value * (1 + +markup.value/100);
  costPreview.innerText = `Suggested Unit Price: ${peso(sell)}`;
}

baseCost.oninput = updateCostPreview;
markup.oninput = updateCostPreview;

applyCostBtn.onclick = () => {
  const tr = itemsTable.tBodies[0].rows[rowIndex.value];
  const sell = +baseCost.value * (1 + +markup.value/100);
  tr.querySelector('.price').value = sell.toFixed(2);
  calc();
  costModal.style.display = 'none';
};

closeCostBtn.onclick = () => costModal.style.display = 'none';



/* ================== SAVE & HISTORY (TEXT ONLY) ================== */
function saveQuotation(){
  if(!customer.value.trim()){
    alert('Client name required');
    return false;
  }

  const data = {
    qno: qno.value,
    date: qdate.value,
    customer: customer.value,
    total: grand.innerText,
    items: []
  };

  [...itemsTable.tBodies[0].rows].forEach(r => {
    data.items.push({
      desc: r.cells[1].querySelector('input').value,
      qty: r.querySelector('.qty').value,
      price: r.querySelector('.price').value,
      total: r.cells[4].innerText
    });
  });

  quotations.push(data);
  localStorage.setItem('quotations', JSON.stringify(quotations));

  quoteCounter++;
  localStorage.setItem('qcounter', quoteCounter);
  qno.value = quoteCounter;

  renderHistory();
  return true;
}

function renderHistory(){
  historyTable.tBodies[0].innerHTML = '';
  quotations.forEach((q,i) => {
    const r = historyTable.tBodies[0].insertRow();
    r.innerHTML = `<td>${q.qno}</td><td>${q.date}</td><td>${q.customer}</td><td>${q.total}</td><td><button onclick=\"reuseQuotation(${i})\">Reuse</button> <button onclick=\"deleteQuotation(${i})\">Delete</button></td>`;
  });
}

window.reuseQuotation = i => {
  const q = quotations[i];
  qno.value = q.qno + '-R';
  qdate.valueAsDate = new Date();
  customer.value = q.customer;
  itemsTable.tBodies[0].innerHTML = '';
  q.items.forEach(it => addRow(it));
  calc();
};

window.deleteQuotation = i => {
  if(!confirm('Delete this quotation?')) return;
  quotations.splice(i,1);
  localStorage.setItem('quotations', JSON.stringify(quotations));
  renderHistory();
};

/* ================== PDF (HARDENED & PESO SAFE) ================== */



function generatePDF(){
  try{
    const doc = new jsPDF('p','mm','a4');

    // HEADER
    if(sessionLogo){
      try{
        doc.addImage(sessionLogo,'JPEG',14,10,25,18);
      }catch(e){}
    }

    doc.setFontSize(14);
	  doc.text('QUOTATION',105,9,{align:'center'});
    doc.setFontSize(10);
    doc.text('A. N. J DIGITAL PRINTING',105,15,{align:'center'});
    doc.setFontSize(10);
    doc.text(`Client: ${customer.value}`,14,35);
    doc.text(`Date: ${qdate.value}`,150,35);
	doc.text(`Quotation No: ${qno.value}`, 150, 42);

    // BUILD TABLE DATA
const body = [];
const imageMap = {};

[...itemsTable.tBodies[0].rows].forEach((r, i) => {
  const desc  = r.cells[1].querySelector('input')?.value || '';
  const qty   = Number(r.querySelector('.qty')?.value || 0);
  const price = Number(r.querySelector('.price')?.value || 0);
  const total = qty * price;

  if (r.dataset.image) {
    imageMap[i] = r.dataset.image;
  }

  body.push([
    `IMG_${i}`, // placeholder
    desc,
    qty,
    `PHP ${price.toLocaleString('en-PH',{minimumFractionDigits:2})}`,
    `PHP ${total.toLocaleString('en-PH',{minimumFractionDigits:2})}`
  ]);
});



    // AUTO TABLE
doc.autoTable({
  startY: 45,
  head: [[
    'Image',
    'Item Description',
    'Qty',
    'Unit Price',
    'Total'
  ]],
  body,

  styles: {
    fontSize: 10,
    cellPadding: 4,
    valign: 'middle'
  },

  columnStyles: {
    0: { cellWidth: 25 },   // Image column
    1: { cellWidth: 80 },
    2: { halign: 'center' },
    3: { halign: 'right' },
    4: { halign: 'right' }
  },

  // ✅ REMOVE TEXT BEFORE RENDERING
  didParseCell(data) {
    if (
      data.section === 'body' &&
      data.column.index === 0 &&
      typeof data.cell.raw === 'string' &&
      data.cell.raw.startsWith('IMG_')
    ) {
      data.cell.text = ['']; // remove IM / IMG text
    }
  },

  // ✅ DRAW IMAGE AFTER CELL IS READY
  didDrawCell(data) {
    if (
      data.section === 'body' &&
      data.column.index === 0 &&
      typeof data.cell.raw === 'string' &&
      data.cell.raw.startsWith('IMG_')
    ) {
      const rowIndex = Number(data.cell.raw.replace('IMG_', ''));
      const img = imageMap[rowIndex];

      if (img) {
        try {
          const size = 10; // adjust image size here
          const x = data.cell.x + (data.cell.width - size) / 2;
          const y = data.cell.y + (data.cell.height - size) / 2;

          doc.addImage(img, 'JPEG', x, y, size, size);
        } catch (e) {
          console.warn('Image skipped', e);
        }
      }
    }
  }
});



    // GRAND TOTAL
  let grandTotal = 0;

[...itemsTable.tBodies[0].rows].forEach(r => {
  const qty   = Number(r.querySelector('.qty')?.value || 0);
  const price = Number(r.querySelector('.price')?.value || 0);
  grandTotal += qty * price;
});

doc.setFontSize(11);
doc.text(
  `TOTAL: PHP ${grandTotal.toLocaleString('en-PH',{minimumFractionDigits:2})}`,
  190,
  doc.lastAutoTable.finalY + 10,
  { align:'right' }
);

// ===== REMARKS SECTION =====
const remarksText = remarks.value?.trim();

if (remarksText) {
  let y = doc.lastAutoTable.finalY + 20;
  const pageHeight = doc.internal.pageSize.getHeight();

  // Prevent page overflow
  if (y > pageHeight - 40) {
    doc.addPage();
    y = 30;
  }

  doc.setFontSize(10);
  doc.setFont(undefined, 'bold');
  doc.text('Remarks:', 14, y);

  doc.setFont(undefined, 'normal');

  const remarkLines = doc.splitTextToSize(remarksText, 180);
  doc.text(remarkLines, 14, y + 6);
}


    doc.save(`Quotation_${qno.value}.pdf`);

  }catch(e){
    console.error('PDF failed', e);
    alert('PDF generation failed. Check console.');
  }
}


/* ================== EVENTS & INIT ================== */
addItemBtn.onclick = () => addRow();
saveBtn.onclick = () => { if(saveQuotation()) generatePDF(); };

addRow();
renderHistory();
</script>
</body>
</html>
